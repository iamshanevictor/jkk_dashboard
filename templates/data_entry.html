{% extends "base.html" %}

{% block title %}Precision Pricing - Data Entry{% endblock %}

{% block head_extra %}
<style>
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
    }
    
    .calendar-day {
        aspect-ratio: 1;
        min-height: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        font-size: 14px;
        border-radius: 8px;
    }
    
    .calendar-day:hover {
        transform: scale(1.05);
        z-index: 10;
    }
    
    .calendar-day.other-month {
        color: #9CA3AF;
        background-color: #F9FAFB;
    }
    
    .calendar-day.today {
        border: 2px solid #3B82F6;
        font-weight: bold;
    }
    
    .calendar-day.selected {
        background-color: #3B82F6;
        color: white;
        font-weight: bold;
    }
    
    .calendar-day.booked {
        background-color: #EF4444;
        color: white;
    }
    
    .calendar-day.past {
        background-color: #F3F4F6 !important;
        color: #9CA3AF !important;
        cursor: not-allowed !important;
        opacity: 0.6 !important;
    }
    
    .calendar-day.past:hover {
        transform: none !important;
        cursor: not-allowed !important;
        background-color: #F3F4F6 !important;
    }
    
    /* Ensure past dates always look disabled even if they have other classes */
    .calendar-day.past.selected {
        background-color: #F3F4F6 !important;
        color: #9CA3AF !important;
    }
    
    .calendar-day.disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .calendar-day.disabled:hover {
        transform: none;
        cursor: not-allowed;
    }
    
    .calendar-day.range-start {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    
    .calendar-day.range-end {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
    
    .calendar-day.range-middle {
        border-radius: 0;
        background-color: #93C5FD;
    }
    
    .price-indicator {
        position: absolute;
        bottom: 2px;
        right: 2px;
        font-size: 10px;
        background-color: rgba(0,0,0,0.7);
        color: white;
        padding: 1px 3px;
        border-radius: 3px;
    }

    /* Unit Card Styles */
    .unit-card {
        background: #ffffff;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .unit-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .unit-card:hover {
        border-color: #3b82f6;
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.15);
    }
    
    .unit-card:hover::before {
        opacity: 1;
    }
    
    .unit-card.selected {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border-color: #1d4ed8;
        color: white;
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
    }
    
    .unit-card.selected::before {
        opacity: 0;
    }
    
    .unit-card.selected .text-gray-900 {
        color: white !important;
    }
    
    .unit-card.selected .text-gray-500 {
        color: #e0e7ff !important;
    }
    
    .unit-card.selected .text-gray-600 {
        color: white !important;
    }
    
    .unit-card:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    
    @media (max-width: 640px) {
        .unit-card {
            padding: 1rem;
        }
    }
    
    @media (max-width: 768px) {
        .calendar-day {
            min-height: 45px;
            font-size: 12px;
        }
        .price-indicator {
            font-size: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
    <h2 class="text-2xl font-semibold mb-6 text-gray-800">Booking Calendar</h2>
    <p class="text-gray-600 mb-6 text-center">Select dates to record pricing and booking information. Click and drag to select multiple dates.</p>

    <!-- Unit Selection -->
    <div class="mb-8">
        <h3 class="text-lg font-medium text-gray-900 mb-4 text-center">
            Select Property Unit <span class="text-red-500" aria-label="required">*</span>
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-w-4xl mx-auto">
            {% for unit in units %}
            <div class="unit-card cursor-pointer border-2 border-gray-200 rounded-lg p-6 text-center transition-all duration-200 hover:border-blue-300 hover:shadow-md" 
                 data-unit-id="{{ unit.unit_id }}" 
                 role="button" 
                 tabindex="0"
                 aria-label="Select {{ unit.property_name }}">
                <div class="mb-3">
                    {% if 'STUDIO' in unit.property_name.upper() or 'STD' in unit.property_name.upper() %}
                        <!-- Hotel/Studio Icon -->
                        <svg class="w-8 h-8 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    {% elif 'VILLA' in unit.property_name.upper() or 'HOUSE' in unit.property_name.upper() %}
                        <!-- House/Villa Icon -->
                        <svg class="w-8 h-8 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                    {% elif 'CONDO' in unit.property_name.upper() or 'APT' in unit.property_name.upper() %}
                        <!-- Building/Condo Icon -->
                        <svg class="w-8 h-8 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    {% else %}
                        <!-- Default Home Icon -->
                        <svg class="w-8 h-8 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                    {% endif %}
                </div>
                <div class="font-bold text-lg text-gray-900 mb-1">{{ unit.property_name }}</div>
                <div class="text-xs text-gray-400">{{ unit.unit_id }}</div>
                <div class="text-sm text-gray-500">Click to manage</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Calendar Section -->
    <div id="calendar-section" class="hidden">
        <!-- Calendar Header -->
        <div class="max-w-4xl mx-auto mb-6">
            <div class="flex justify-between items-center mb-4">
                <button id="prev-month" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors duration-200" aria-label="Previous month">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h3 id="calendar-month-year" class="text-xl font-semibold text-gray-800"></h3>
                <button id="next-month" class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors duration-200" aria-label="Next month">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>

            <!-- Legend -->
            <div class="flex flex-wrap justify-center gap-6 text-sm mb-4">
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-blue-500 rounded mr-2"></div>
                    <span>Selected</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
                    <span>Booked</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-gray-300 rounded mr-2"></div>
                    <span>Available</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-gray-200 rounded mr-2 opacity-60"></div>
                    <span class="text-gray-500">Past Date</span>
                </div>
                </div>
            </div>

        <!-- Calendar Grid -->
        <div class="max-w-4xl mx-auto mb-8">
            <div class="bg-white rounded-lg shadow-lg p-4">
                <!-- Day Headers -->
                <div class="calendar-grid mb-2">
                    <div class="text-center font-semibold text-gray-600 py-2">Sun</div>
                    <div class="text-center font-semibold text-gray-600 py-2">Mon</div>
                    <div class="text-center font-semibold text-gray-600 py-2">Tue</div>
                    <div class="text-center font-semibold text-gray-600 py-2">Wed</div>
                    <div class="text-center font-semibold text-gray-600 py-2">Thu</div>
                    <div class="text-center font-semibold text-gray-600 py-2">Fri</div>
                    <div class="text-center font-semibold text-gray-600 py-2">Sat</div>
            </div>

                <!-- Calendar Days -->
                <div id="calendar-grid" class="calendar-grid"></div>
                </div>
            </div>

        <!-- Selection Summary -->
        <div id="selection-summary" class="hidden max-w-2xl mx-auto mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
            <h4 class="text-lg font-semibold text-blue-800 mb-4">Selected Dates Summary</h4>
            <div id="selected-dates-list" class="mb-4"></div>
            <p class="text-sm text-blue-600 mb-4">Click "Set Pricing & Booking Info" to configure details for all selected dates.</p>
            <button id="configure-dates-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                Set Pricing & Booking Info
            </button>
        </div>

        <!-- Bulk Entry Modal -->
        <div id="bulk-entry-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-md w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Bulk Entry for Selected Dates</h3>
                        <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
            </div>

                    <form id="bulk-entry-form" class="space-y-4">
                        <div>
                            <label for="bulk-price" class="block text-sm font-medium text-gray-700 mb-2">
                                Listed Price (₱) <span class="text-red-500">*</span>
                            </label>
                            <input type="number" id="bulk-price" name="bulk-price" step="0.01" min="0" required
                                   class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Booking Status <span class="text-red-500">*</span>
                            </label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="bulk-booking" value="booked" class="mr-2" checked>
                                    <span>All dates are booked</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="bulk-booking" value="available" class="mr-2">
                                    <span>All dates are available (not booked)</span>
                                </label>
                            </div>
            </div>


                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" id="cancel-bulk" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" id="save-bulk" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Save All Dates
            </button>
                        </div>
        </form>
                </div>
            </div>
        </div>
    </div>

    <div id="toastNotification" class="hidden fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg transition-opacity duration-300 opacity-0">
        Entry logged successfully!
    </div>
{% endblock %}

{% block scripts_extra %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Calendar state
        let currentDate = new Date();
        let selectedDates = new Set();
        let existingBookings = new Map(); // Store existing booking data
        let currentUnit = null;
        let isSelecting = false;
        let selectionStart = null;

        // Elements
        const unitCards = document.querySelectorAll('.unit-card');
        const calendarSection = document.getElementById('calendar-section');
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearDisplay = document.getElementById('calendar-month-year');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const selectionSummary = document.getElementById('selection-summary');
        const selectedDatesList = document.getElementById('selected-dates-list');
        const configureDatesBtn = document.getElementById('configure-dates-btn');
        const bulkEntryModal = document.getElementById('bulk-entry-modal');
        const bulkEntryForm = document.getElementById('bulk-entry-form');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelBulkBtn = document.getElementById('cancel-bulk');

        // Month names
        const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];

        // Unit card selection handlers
        unitCards.forEach(card => {
            card.addEventListener('click', async function() {
                // Remove selected class from all cards
                unitCards.forEach(c => c.classList.remove('selected'));
                
                // Add selected class to clicked card
                this.classList.add('selected');
                
                // Clear any previously selected dates when switching units
                selectedDates.clear();
                updateSelectionSummary();
                
                // Set current unit
                currentUnit = this.dataset.unitId;
                
                // Show calendar and load data
                calendarSection.classList.remove('hidden');
                await loadExistingBookings(); // Wait for bookings to load
                renderCalendar(); // Then render calendar with the loaded data
            });
            
            // Handle keyboard navigation
            card.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });

        // Calendar navigation
        prevMonthBtn.addEventListener('click', async () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            if (currentUnit) {
                await loadExistingBookings(); // Reload bookings for new month
            }
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', async () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            if (currentUnit) {
                await loadExistingBookings(); // Reload bookings for new month
            }
            renderCalendar();
        });

        // Load existing bookings for the selected unit
        async function loadExistingBookings() {
            if (!currentUnit) return;

            try {
                console.log(`Loading bookings for unit: ${currentUnit}`); // Debug log
                
                // Get existing price logs for this unit
                const response = await fetch(`/api/unit-bookings/${currentUnit}`);
                if (response.ok) {
                    const bookings = await response.json();
                    existingBookings.clear();
                    bookings.forEach(booking => {
                        existingBookings.set(booking.date, booking);
                    });
                    console.log(`Loaded ${bookings.length} bookings for ${currentUnit}`); // Debug log
            } else {
                    console.warn(`Failed to load bookings: ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading existing bookings:', error);
            }
        }

        // Render calendar
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            monthYearDisplay.textContent = `${monthNames[month]} ${year}`;
            
            // Clear calendar
            calendarGrid.innerHTML = '';
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Add empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                const prevMonthDay = new Date(year, month, 1 - (startingDayOfWeek - i));
                emptyDay.textContent = prevMonthDay.getDate();
                calendarGrid.appendChild(emptyDay);
            }
            
            // Add days of current month
            const today = new Date().toISOString().split('T')[0];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === today;
                const isPast = dateStr < today;
                
                dayElement.className = 'calendar-day bg-gray-100 hover:bg-gray-200';
                dayElement.textContent = day;
                dayElement.dataset.date = dateStr;
                
                let isDisabled = false;
                
                // Check if date is in the past
                if (isPast) {
                    dayElement.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    dayElement.classList.add('past');
                    isDisabled = true;
                    
                    // Clean up: Remove past dates from selectedDates if they exist
                    if (selectedDates.has(dateStr)) {
                        selectedDates.delete(dateStr);
                    }
                }
                
                // Apply styling based on state
                if (isToday) {
                    dayElement.classList.add('today');
                }
                
                // Only apply selected styling if date is not disabled
                if (selectedDates.has(dateStr) && !isDisabled) {
                    dayElement.classList.remove('bg-gray-100');
                    dayElement.classList.add('selected');
                } else if (selectedDates.has(dateStr) && isDisabled) {
                    // Remove from selected dates if it becomes disabled (shouldn't happen but safety check)
                    selectedDates.delete(dateStr);
                }
                
                // Check if date has existing booking data
                if (existingBookings.has(dateStr)) {
                    const booking = existingBookings.get(dateStr);
                    dayElement.classList.remove('bg-gray-100');
                    if (booking.was_booked) {
                        dayElement.classList.add('booked');
                        isDisabled = true; // Booked dates cannot be selected
                        
                        // Clean up: Remove booked dates from selectedDates if they exist
                        if (selectedDates.has(dateStr)) {
                            selectedDates.delete(dateStr);
                        }
                    }
                    // Available dates keep the default gray styling
                    
                    // Add price indicator
                    const priceIndicator = document.createElement('div');
                    priceIndicator.className = 'price-indicator';
                    priceIndicator.textContent = `₱${booking.our_listed_price}`;
                    dayElement.appendChild(priceIndicator);
                }
                
                // Mark as disabled if needed
                if (isDisabled) {
                    dayElement.classList.add('disabled');
                    dayElement.dataset.disabled = 'true';
                } else {
                    // Add click handlers only for enabled dates
                    dayElement.addEventListener('mousedown', handleDateMouseDown);
                    dayElement.addEventListener('mouseenter', handleDateMouseEnter);
                }
                dayElement.addEventListener('mouseup', handleDateMouseUp);
                
                calendarGrid.appendChild(dayElement);
            }
            
            // Add days from next month to fill grid
            const totalCells = calendarGrid.children.length;
            const remainingCells = 42 - totalCells; // 6 rows × 7 days
            for (let i = 1; i <= remainingCells; i++) {
                const nextMonthDay = document.createElement('div');
                nextMonthDay.className = 'calendar-day other-month';
                nextMonthDay.textContent = i;
                calendarGrid.appendChild(nextMonthDay);
            }
            
            // Update selection summary after cleaning up disabled dates
            updateSelectionSummary();
        }

        // Date selection handlers
        function handleDateMouseDown(event) {
            if (!event.target.dataset.date) return;
            
            // Check if date is disabled (past or booked)
            if (event.target.dataset.disabled === 'true') {
                if (event.target.classList.contains('past')) {
                    showToast('Cannot select past dates', 'error');
                } else if (event.target.classList.contains('booked')) {
                    showToast('Cannot select already booked dates', 'error');
                }
                return;
            }
            
            isSelecting = true;
            selectionStart = event.target.dataset.date;
            
            // Toggle selection for single click
            if (selectedDates.has(selectionStart)) {
                selectedDates.delete(selectionStart);
            } else {
                selectedDates.add(selectionStart);
            }
            
            updateCalendarDisplay();
            updateSelectionSummary();
            event.preventDefault();
        }

        function handleDateMouseEnter(event) {
            if (!isSelecting || !event.target.dataset.date) return;
            
            // Clear current selection
            selectedDates.clear();
            
            // Select range from start to current
            const currentDateStr = event.target.dataset.date;
            let startDate = new Date(selectionStart);
            let endDate = new Date(currentDateStr);
            
            if (startDate > endDate) {
                const temp = startDate;
                startDate = endDate;
                endDate = temp;
            }
            
            let date = new Date(startDate);
            const today = new Date().toISOString().split('T')[0];
            
            while (date <= endDate) {
                const dateStr = date.toISOString().split('T')[0];
                
                // Skip past dates and booked dates
                const isPast = dateStr < today;
                const isBooked = existingBookings.has(dateStr) && existingBookings.get(dateStr).was_booked;
                
                if (!isPast && !isBooked) {
                    selectedDates.add(dateStr);
                }
                date.setDate(date.getDate() + 1);
            }
            
            updateCalendarDisplay();
            updateSelectionSummary();
        }

        function handleDateMouseUp() {
            isSelecting = false;
            selectionStart = null;
        }

        // Prevent text selection during drag
        document.addEventListener('selectstart', function(event) {
            if (isSelecting) {
                event.preventDefault();
            }
        });

        function updateCalendarDisplay() {
            const dayElements = calendarGrid.querySelectorAll('.calendar-day[data-date]');
            const today = new Date().toISOString().split('T')[0];
            
            dayElements.forEach(element => {
                const dateStr = element.dataset.date;
                const isPast = dateStr < today;
                
                // Reset classes
                element.className = 'calendar-day';
                
                let isDisabled = false;
                
                // Check if date is in the past - MUST BE FIRST
                if (isPast) {
                    element.classList.add('past', 'disabled');
                    element.dataset.disabled = 'true';
                    isDisabled = true;
                    
                    // Clean up: Remove past dates from selectedDates if they exist
                    if (selectedDates.has(dateStr)) {
                        selectedDates.delete(dateStr);
                    }
                } else {
                    // Apply base styling for non-past dates
                    if (!existingBookings.has(dateStr)) {
                        element.classList.add('bg-gray-100', 'hover:bg-gray-200');
                    }
                }
                
                // Apply existing booking styling
                if (existingBookings.has(dateStr)) {
                    const booking = existingBookings.get(dateStr);
                    if (booking.was_booked) {
                        element.classList.add('booked', 'disabled');
                        element.dataset.disabled = 'true';
                        isDisabled = true;
                        
                        // Clean up: Remove booked dates from selectedDates if they exist
                        if (selectedDates.has(dateStr)) {
                            selectedDates.delete(dateStr);
                        }
                    }
                    // Available dates keep the default gray styling
                }
                
                // Apply selection styling ONLY if not disabled
                if (selectedDates.has(dateStr) && !isDisabled) {
                    element.classList.remove('bg-gray-100');
                    element.classList.add('selected');
                }
                
                // Today styling
                if (dateStr === today) {
                    element.classList.add('today');
                }
            });
        }

        function updateSelectionSummary() {
            if (selectedDates.size === 0) {
                selectionSummary.classList.add('hidden');
                return;
            }
            
            selectionSummary.classList.remove('hidden');
            
            const sortedDates = Array.from(selectedDates).sort();
            const dateRanges = getDateRanges(sortedDates);
            
            selectedDatesList.innerHTML = dateRanges.map(range => {
                if (range.start === range.end) {
                    return `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm mr-2 mb-1">${formatDate(range.start)}</span>`;
                } else {
                    return `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm mr-2 mb-1">${formatDate(range.start)} - ${formatDate(range.end)}</span>`;
                }
            }).join('');
        }

        function getDateRanges(dates) {
            if (dates.length === 0) return [];
            
            const ranges = [];
            let start = dates[0];
            let end = dates[0];
            
            for (let i = 1; i < dates.length; i++) {
                const current = new Date(dates[i]);
                const previous = new Date(dates[i - 1]);
                
                if (current.getTime() - previous.getTime() === 86400000) { // 1 day in milliseconds
                    end = dates[i];
            } else {
                    ranges.push({ start, end });
                    start = dates[i];
                    end = dates[i];
                }
            }
            
            ranges.push({ start, end });
            return ranges;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function resetSelection() {
            selectedDates.clear();
            updateSelectionSummary();
        }

        // Modal handlers
        configureDatesBtn.addEventListener('click', () => {
            bulkEntryModal.classList.remove('hidden');
        });

        closeModalBtn.addEventListener('click', closeModal);
        cancelBulkBtn.addEventListener('click', closeModal);

        function closeModal() {
            bulkEntryModal.classList.add('hidden');
            bulkEntryForm.reset();
        }

        // Bulk entry form submission
        bulkEntryForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const formData = new FormData(bulkEntryForm);
            const bulkPriceRaw = formData.get('bulk-price');
            const bulkPrice = parseFloat(bulkPriceRaw);
            const bulkBooking = formData.get('bulk-booking');
            
            // Debug logging
            console.log('Form data:', {
                bulkPriceRaw,
                bulkPrice,
                bulkBooking
            });
            
            // Validate form data
            if (!bulkPriceRaw || !bulkPrice || bulkPrice <= 0) {
                showToast(`Please enter a valid price (received: "${bulkPriceRaw}")`, 'error');
                return;
            }
            
            if (!bulkBooking) {
                showToast('Please select a booking status', 'error');
                return;
            }
            
            const entries = Array.from(selectedDates).map(date => ({
                unit_id: currentUnit,
                date: date,
                listed_price: bulkPrice,
                was_booked: bulkBooking === 'booked' ? 'Y' : 'N' // Y for booked, N for available
                // lead_time will be calculated automatically by the backend
            }));
            
            try {
                // Save all entries
                for (const entry of entries) {
                    console.log('Sending entry:', entry); // Debug log
                    
                const response = await fetch('/log_entry', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(entry)
                });

                if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `Failed to save entry for ${entry.date} (${response.status})`);
                    }
                    
                    const result = await response.json();
                    console.log('Entry saved:', result);
                }
                
                showToast(`Successfully saved ${entries.length} price entries`, 'success');
                closeModal();
                resetSelection();
                await loadExistingBookings(); // Wait for reload
                renderCalendar();

            } catch (error) {
                console.error('Error saving bulk entries:', error);
                showToast(`Error: ${error.message}`, 'error');
            }
        });

        // Calendar will be initialized when a unit is selected
    });
</script>
{% endblock %}
