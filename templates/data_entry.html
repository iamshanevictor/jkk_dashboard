{% extends "base.html" %}

{% block title %}Rentalytics{% endblock %}

{% block head_extra %}
<style>
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
    }
    
    .calendar-day {
        aspect-ratio: 1;
        min-height: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        font-size: 14px;
        border-radius: 8px;
        background-color: #2a2a2a;
        color: #e5e7eb;
        border: 1px solid #3a3a3a;
    }
    
    .calendar-day:hover {
        transform: scale(1.05);
        z-index: 10;
        background-color: #3a3a3a;
    }
    
    .calendar-day.other-month {
        color: #6B7280;
        background-color: #1a1a1a;
        opacity: 0.5;
    }
    
    .calendar-day.today {
        border: 2px solid #3B82F6;
        font-weight: bold;
        background-color: #2a2a2a;
        color: #ffffff;
    }
    
    .calendar-day.selected {
        background-color: #3B82F6;
        color: white;
        font-weight: bold;
        border-color: #3B82F6;
    }
    
    .calendar-day.booked {
        background-color: #EF4444;
        color: white;
        border-color: #EF4444;
    }
    
    .calendar-day.past {
        background-color: #1a1a1a !important;
        color: #4B5563 !important;
        cursor: not-allowed !important;
        opacity: 0.3 !important;
        border-color: #2a2a2a !important;
    }
    
    .calendar-day.past:hover {
        transform: none !important;
        cursor: not-allowed !important;
        background-color: #1a1a1a !important;
    }
    
    /* Ensure past dates always look disabled even if they have other classes */
    .calendar-day.past.selected {
        background-color: #1a1a1a !important;
        color: #4B5563 !important;
    }
    
    .calendar-day.disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .calendar-day.disabled:hover {
        transform: none;
        cursor: not-allowed;
    }
    
    .calendar-day.range-start {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    
    .calendar-day.range-end {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
    
    .calendar-day.range-middle {
        border-radius: 0;
        background-color: #93C5FD;
    }
    
    .price-indicator {
        position: absolute;
        bottom: 2px;
        right: 2px;
        font-size: 10px;
        background-color: rgba(0,0,0,0.7);
        color: white;
        padding: 1px 3px;
        border-radius: 3px;
    }

    /* Unit Card Styles */
    .unit-card {
        background: #1a1a1a;
        border: 2px solid #2a2a2a;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: visible;
    }
    
    .unit-card:hover {
        border-color: #3b82f6;
    }
    
    .unit-card.selected {
        border-color: #2563eb;
        background-color: #2a2a2a;
        ring: 2px;
        box-shadow: 0 0 0 2px #2563eb;
    }
    
    .unit-card .checkmark {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    body.light-theme .unit-card {
        background: #ffffff;
        border-color: #e5e7eb;
    }
    
    body.light-theme .unit-card:hover {
        border-color: #3b82f6;
        background: #f9fafb;
    }
    
    body.light-theme .unit-card.selected {
        border-color: #2563eb;
        background-color: #f3f4f6;
        box-shadow: 0 0 0 2px #2563eb;
    }
    
    body.light-theme .unit-card .text-white {
        color: #111827 !important;
    }
    
    body.light-theme .unit-card .text-gray-400 {
        color: #6b7280 !important;
    }
    
    .unit-card:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    
    @media (max-width: 640px) {
        .unit-card {
            padding: 1rem;
        }
    }
    
    @media (max-width: 768px) {
        .calendar-day {
            min-height: 45px;
            font-size: 12px;
        }
        .price-indicator {
            font-size: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="max-w-6xl mx-auto space-y-4">
        <div>
            <h2 class="text-2xl font-semibold text-themed">Booking Calendar</h2>
            <p class="text-themed-muted text-sm mt-1">Select dates to record pricing and booking information. Click and drag to select multiple dates.</p>
        </div>

        <!-- Unit Selection -->
        <div>
            <div class="flex items-center justify-between flex-wrap gap-3 mb-2">
                <h3 class="text-lg font-medium text-themed">Select Property Unit <span class="text-red-400" aria-label="required">*</span></h3>
                <div class="text-sm text-themed-muted">Pick a unit to load its calendar and bookings</div>
            </div>
            <div id="unitCardsContainer" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
            {% for unit in units %}
            <div class="unit-card p-3 rounded-lg border-2 border-gray-700 cursor-pointer transition-all duration-200 hover:border-blue-500 min-h-20 flex flex-col justify-between relative" 
                 data-unit-id="{{ unit.unit_id }}" 
                 role="button" 
                 tabindex="0"
                 aria-label="Select {{ unit.unit_id }}">
                <div>
                    <div class="text-sm font-semibold text-white">{{ unit.unit_id }}</div>
                    <div class="text-xs text-gray-400">{{ unit.property_name }}</div>
                </div>
                <div class="checkmark absolute top-2 right-2 hidden">
                    <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Calendar Section -->
    <div id="calendar-section" class="hidden max-w-6xl mx-auto space-y-4">
        <!-- Calendar Header + Legend -->
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 lg:gap-6">
            <div class="flex items-center gap-3 flex-wrap">
                <button id="prev-month" class="p-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-white transition-colors duration-200" aria-label="Previous month">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h3 id="calendar-month-year" class="text-xl font-semibold text-themed"></h3>
                <button id="next-month" class="p-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-white transition-colors duration-200" aria-label="Next month">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>

                <!-- Legend -->
                <div class="calendar-legend flex flex-wrap items-center gap-4 text-sm text-themed-muted">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-blue-500 rounded"></div>
                        <span>Selected</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="legend-booked w-4 h-4 bg-red-500 rounded"></div>
                        <span>Booked</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-gray-700 rounded"></div>
                        <span>Available</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-gray-800 rounded opacity-60"></div>
                        <span class="text-gray-500">Past Date</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar + Summary side by side on wide screens -->
        <div class="grid lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2">
                <div class="content-card rounded-lg p-4">
                    <!-- Day Headers -->
                    <div class="calendar-grid mb-2">
                        <div class="text-center font-semibold text-gray-400 py-2">Sun</div>
                        <div class="text-center font-semibold text-gray-400 py-2">Mon</div>
                        <div class="text-center font-semibold text-gray-400 py-2">Tue</div>
                        <div class="text-center font-semibold text-gray-400 py-2">Wed</div>
                        <div class="text-center font-semibold text-gray-400 py-2">Thu</div>
                        <div class="text-center font-semibold text-gray-400 py-2">Fri</div>
                        <div class="text-center font-semibold text-gray-400 py-2">Sat</div>
                    </div>

                    <!-- Calendar Days -->
                    <div id="calendar-grid" class="calendar-grid"></div>
                </div>
            </div>

            <!-- Selection Summary & Bulk Entry Form -->
            <div id="selection-summary" class="h-full p-6 content-card rounded-lg border-l-4 border-blue-500 overflow-y-auto">
                <h4 class="text-lg font-semibold text-blue-400 mb-4">Pricing & Booking Info</h4>
                
                <!-- Selected Dates List -->
                <div id="selected-dates-list" class="mb-6 p-4 bg-blue-50 dark:bg-blue-950 rounded-lg border border-blue-200 dark:border-blue-800">
                    <p class="text-sm text-gray-600 dark:text-gray-300">Select dates on the calendar to begin.</p>
                </div>

                <!-- Form (always visible) -->
                <form id="inline-entry-form" class="space-y-4">
                    <div>
                        <label for="inline-price" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Listed Price (₱) <span class="text-red-400">*</span>
                        </label>
                        <input type="number" id="inline-price" name="inline-price" step="0.01" min="0" required
                               class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 dark:bg-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Booking Status <span class="text-red-400">*</span>
                        </label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="inline-booking" value="booked" class="mr-2" checked>
                                <span class="text-gray-700 dark:text-gray-300">All dates are booked</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="inline-booking" value="available" class="mr-2">
                                <span class="text-gray-700 dark:text-gray-300">All dates are available (not booked)</span>
                            </label>
                        </div>
                    </div>

                    <button type="submit" id="save-inline-btn" class="w-full bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Save All Dates
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="mb-8 mt-8">
        <h3 class="text-lg font-medium text-themed mb-4">Summary Statistics</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="stat-card p-6 rounded-lg border-l-4 border-blue-500">
                <h3 class="text-sm font-medium text-themed-muted">Total Entries</h3>
                <p class="text-3xl font-bold text-themed mt-2">{{ summary_stats.total_entries }}</p>
            </div>
            <div class="stat-card p-6 rounded-lg border-l-4 border-green-500">
                <h3 class="text-sm font-medium text-themed-muted">Booked Entries</h3>
                <p class="text-3xl font-bold text-themed mt-2">{{ summary_stats.booked_entries }}</p>
            </div>
            <div class="stat-card p-6 rounded-lg border-l-4 border-red-500">
                <h3 class="text-sm font-medium text-themed-muted">Not Booked Entries</h3>
                <p class="text-3xl font-bold text-themed mt-2">{{ summary_stats.not_booked_entries }}</p>
            </div>
        </div>

        <div class="content-card p-6 mb-8">
            <h3 class="text-lg font-semibold text-themed">Average Listed Price: <span class="text-blue-400">₱{{ summary_stats.avg_listed_price }}</span></h3>
        </div>
    </div>

    <!-- Recent Pricing Entries Table -->
    <div class="content-card p-6 mb-8">
        <h3 class="text-lg font-semibold text-themed mb-4">Recent Pricing Entries</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-900">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-themed-muted uppercase tracking-wider">Date</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-themed-muted uppercase tracking-wider">Unit ID</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-themed-muted uppercase tracking-wider">Listed Price (₱)</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-themed-muted uppercase tracking-wider">Booked?</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-themed-muted uppercase tracking-wider">Lead Time</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-themed-muted uppercase tracking-wider">Day</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-themed-muted uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">
                    {% for entry in dashboard_data %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-themed">{{ entry.date }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-themed">{{ entry.unit_id }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-themed font-medium">₱{{ entry.listed_price }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-themed">{{ entry.was_booked }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-themed">{{ entry.lead_time }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-themed">{{ entry.day_of_week }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="deleteBooking('{{ entry.id }}', '{{ entry.date }}', '{{ entry.unit_id }}')" 
                                    class="inline-flex items-center bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500"
                                    title="Delete this booking entry">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-themed-muted">No pricing entries available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border border-gray-700 w-96 shadow-lg rounded-md content-card">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-900">
                    <svg class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-themed mt-2">Delete Booking Entry</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-themed-muted" id="delete-message">
                        Are you sure you want to delete this booking entry? This action cannot be undone.
                    </p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-24 mr-2 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        Delete
                    </button>
                    <button id="cancel-delete" class="px-4 py-2 bg-gray-700 text-white text-base font-medium rounded-md w-24 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="toastNotification" class="hidden fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg transition-opacity duration-300 opacity-0">
        Entry logged successfully!
    </div>
{% endblock %}

{% block scripts_extra %}
<script>
    // Delete booking functionality
    let deleteEntryId = null;
    
    function deleteBooking(entryId, date, unitId) {
        deleteEntryId = entryId;
        document.getElementById('delete-message').textContent = 
            `Are you sure you want to delete the booking entry for ${unitId} on ${date}? This action cannot be undone.`;
        document.getElementById('delete-modal').classList.remove('hidden');
    }
    
    document.getElementById('confirm-delete').addEventListener('click', async function() {
        if (!deleteEntryId) return;
        
        try {
            const response = await fetch(`/api/delete-booking/${deleteEntryId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                window.location.reload();
            } else {
                const errorData = await response.json();
                alert(`Error deleting booking: ${errorData.error}`);
            }
        } catch (error) {
            console.error('Error deleting booking:', error);
            alert('Failed to delete booking entry');
        }
        
        document.getElementById('delete-modal').classList.add('hidden');
        deleteEntryId = null;
    });
    
    document.getElementById('cancel-delete').addEventListener('click', function() {
        document.getElementById('delete-modal').classList.add('hidden');
        deleteEntryId = null;
    });
    
    document.getElementById('delete-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
            deleteEntryId = null;
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Calendar state
        let currentDate = new Date();
        let selectedDates = new Set();
        let existingBookings = new Map(); // Store existing booking data
        let currentUnit = null;
        let isSelecting = false;
        let selectionStart = null;

        // Elements
        const unitCards = document.querySelectorAll('.unit-card');
        const calendarSection = document.getElementById('calendar-section');
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearDisplay = document.getElementById('calendar-month-year');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const selectionSummary = document.getElementById('selection-summary');
        const selectedDatesList = document.getElementById('selected-dates-list');
        const inlineEntryForm = document.getElementById('inline-entry-form');
        const inlinePriceInput = document.getElementById('inline-price');
        const inlineBookingRadios = document.querySelectorAll('input[name="inline-booking"]');
        const saveInlineBtn = document.getElementById('save-inline-btn');

        // Month names
        const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];

        // Unit card selection handlers
        unitCards.forEach(card => {
            card.addEventListener('click', async function() {
                // Remove active state from all cards
                unitCards.forEach(c => {
                    c.classList.remove('border-blue-500', 'bg-gray-800', 'ring-2', 'ring-blue-500', 'selected');
                    const checkmark = c.querySelector('.checkmark');
                    if (checkmark) {
                        checkmark.classList.add('hidden');
                    }
                });
                
                // Add active state to clicked card
                this.classList.add('border-blue-500', 'bg-gray-800', 'ring-2', 'ring-blue-500', 'selected');
                const checkmark = this.querySelector('.checkmark');
                if (checkmark) {
                    checkmark.classList.remove('hidden');
                }
                
                // Clear any previously selected dates when switching units
                selectedDates.clear();
                updateSelectionSummary();
                
                // Set current unit
                currentUnit = this.dataset.unitId;
                
                // Show calendar and load data
                calendarSection.classList.remove('hidden');
                await loadExistingBookings(); // Wait for bookings to load
                renderCalendar(); // Then render calendar with the loaded data
            });
            
            // Handle keyboard navigation
            card.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
        
        // Auto-select first card on page load
        if (unitCards.length > 0) {
            unitCards[0].click();
        }

        // Calendar navigation
        prevMonthBtn.addEventListener('click', async () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            if (currentUnit) {
                await loadExistingBookings(); // Reload bookings for new month
            }
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', async () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            if (currentUnit) {
                await loadExistingBookings(); // Reload bookings for new month
            }
            renderCalendar();
        });

        // Load existing bookings for the selected unit
        async function loadExistingBookings() {
            if (!currentUnit) return;

            try {
                console.log(`Loading bookings for unit: ${currentUnit}`); // Debug log
                
                // Get existing price logs for this unit
                const response = await fetch(`/api/unit-bookings/${currentUnit}`);
                if (response.ok) {
                    const bookings = await response.json();
                    existingBookings.clear();
                    bookings.forEach(booking => {
                        existingBookings.set(booking.date, booking);
                    });
                    console.log(`Loaded ${bookings.length} bookings for ${currentUnit}`); // Debug log
            } else {
                    console.warn(`Failed to load bookings: ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading existing bookings:', error);
            }
        }

        // Render calendar
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            monthYearDisplay.textContent = `${monthNames[month]} ${year}`;
            
            // Clear calendar
            calendarGrid.innerHTML = '';
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Add empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                const prevMonthDay = new Date(year, month, 1 - (startingDayOfWeek - i));
                emptyDay.textContent = prevMonthDay.getDate();
                calendarGrid.appendChild(emptyDay);
            }
            
            // Add days of current month
            const today = new Date().toISOString().split('T')[0];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === today;
                const isPast = dateStr < today;
                
                dayElement.className = 'calendar-day bg-gray-100 hover:bg-gray-200';
                dayElement.textContent = day;
                dayElement.dataset.date = dateStr;
                
                let isDisabled = false;
                
                // Check if date is in the past
                if (isPast) {
                    dayElement.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    dayElement.classList.add('past');
                    isDisabled = true;
                    
                    // Clean up: Remove past dates from selectedDates if they exist
                    if (selectedDates.has(dateStr)) {
                        selectedDates.delete(dateStr);
                    }
                }
                
                // Apply styling based on state
                if (isToday) {
                    dayElement.classList.add('today');
                }
                
                // Only apply selected styling if date is not disabled
                if (selectedDates.has(dateStr) && !isDisabled) {
                    dayElement.classList.remove('bg-gray-100');
                    dayElement.classList.add('selected');
                } else if (selectedDates.has(dateStr) && isDisabled) {
                    // Remove from selected dates if it becomes disabled (shouldn't happen but safety check)
                    selectedDates.delete(dateStr);
                }
                
                // Check if date has existing booking data
                if (existingBookings.has(dateStr)) {
                    const booking = existingBookings.get(dateStr);
                    dayElement.classList.remove('bg-gray-100');
                    if (booking.was_booked) {
                        dayElement.classList.add('booked');
                        isDisabled = true; // Booked dates cannot be selected
                        
                        // Clean up: Remove booked dates from selectedDates if they exist
                        if (selectedDates.has(dateStr)) {
                            selectedDates.delete(dateStr);
                        }
                    }
                    // Available dates keep the default gray styling
                    
                    // Add price indicator
                    const priceIndicator = document.createElement('div');
                    priceIndicator.className = 'price-indicator';
                    priceIndicator.textContent = `₱${booking.our_listed_price}`;
                    dayElement.appendChild(priceIndicator);
                }
                
                // Mark as disabled if needed
                if (isDisabled) {
                    dayElement.classList.add('disabled');
                    dayElement.dataset.disabled = 'true';
                } else {
                    // Add click handlers only for enabled dates
                    dayElement.addEventListener('mousedown', handleDateMouseDown);
                    dayElement.addEventListener('mouseenter', handleDateMouseEnter);
                }
                dayElement.addEventListener('mouseup', handleDateMouseUp);
                
                calendarGrid.appendChild(dayElement);
            }
            
            // Add days from next month to fill grid
            const totalCells = calendarGrid.children.length;
            const remainingCells = 42 - totalCells; // 6 rows × 7 days
            for (let i = 1; i <= remainingCells; i++) {
                const nextMonthDay = document.createElement('div');
                nextMonthDay.className = 'calendar-day other-month';
                nextMonthDay.textContent = i;
                calendarGrid.appendChild(nextMonthDay);
            }
            
            // Update selection summary after cleaning up disabled dates
            updateSelectionSummary();
        }

        // Date selection handlers
        function handleDateMouseDown(event) {
            if (!event.target.dataset.date) return;
            
            // Check if date is disabled (past or booked)
            if (event.target.dataset.disabled === 'true') {
                if (event.target.classList.contains('past')) {
                    showToast('Cannot select past dates', 'error');
                } else if (event.target.classList.contains('booked')) {
                    showToast('Cannot select already booked dates', 'error');
                }
                return;
            }
            
            isSelecting = true;
            selectionStart = event.target.dataset.date;
            
            // Toggle selection for single click
            if (selectedDates.has(selectionStart)) {
                selectedDates.delete(selectionStart);
            } else {
                selectedDates.add(selectionStart);
            }
            
            updateCalendarDisplay();
            updateSelectionSummary();
            event.preventDefault();
        }

        function handleDateMouseEnter(event) {
            if (!isSelecting || !event.target.dataset.date) return;
            
            // Clear current selection
            selectedDates.clear();
            
            // Select range from start to current
            const currentDateStr = event.target.dataset.date;
            let startDate = new Date(selectionStart);
            let endDate = new Date(currentDateStr);
            
            if (startDate > endDate) {
                const temp = startDate;
                startDate = endDate;
                endDate = temp;
            }
            
            let date = new Date(startDate);
            const today = new Date().toISOString().split('T')[0];
            
            while (date <= endDate) {
                const dateStr = date.toISOString().split('T')[0];
                
                // Skip past dates and booked dates
                const isPast = dateStr < today;
                const isBooked = existingBookings.has(dateStr) && existingBookings.get(dateStr).was_booked;
                
                if (!isPast && !isBooked) {
                    selectedDates.add(dateStr);
                }
                date.setDate(date.getDate() + 1);
            }
            
            updateCalendarDisplay();
            updateSelectionSummary();
        }

        function handleDateMouseUp() {
            isSelecting = false;
            selectionStart = null;
        }

        // Prevent text selection during drag
        document.addEventListener('selectstart', function(event) {
            if (isSelecting) {
                event.preventDefault();
            }
        });

        function updateCalendarDisplay() {
            const dayElements = calendarGrid.querySelectorAll('.calendar-day[data-date]');
            const today = new Date().toISOString().split('T')[0];
            
            dayElements.forEach(element => {
                const dateStr = element.dataset.date;
                const isPast = dateStr < today;
                
                // Reset classes
                element.className = 'calendar-day';
                
                let isDisabled = false;
                
                // Check if date is in the past - MUST BE FIRST
                if (isPast) {
                    element.classList.add('past', 'disabled');
                    element.dataset.disabled = 'true';
                    isDisabled = true;
                    
                    // Clean up: Remove past dates from selectedDates if they exist
                    if (selectedDates.has(dateStr)) {
                        selectedDates.delete(dateStr);
                    }
                } else {
                    // Apply base styling for non-past dates
                    if (!existingBookings.has(dateStr)) {
                        element.classList.add('bg-gray-100', 'hover:bg-gray-200');
                    }
                }
                
                // Apply existing booking styling
                if (existingBookings.has(dateStr)) {
                    const booking = existingBookings.get(dateStr);
                    if (booking.was_booked) {
                        element.classList.add('booked', 'disabled');
                        element.dataset.disabled = 'true';
                        isDisabled = true;
                        
                        // Clean up: Remove booked dates from selectedDates if they exist
                        if (selectedDates.has(dateStr)) {
                            selectedDates.delete(dateStr);
                        }
                    }
                    // Available dates keep the default gray styling
                }
                
                // Apply selection styling ONLY if not disabled
                if (selectedDates.has(dateStr) && !isDisabled) {
                    element.classList.remove('bg-gray-100');
                    element.classList.add('selected');
                }
                
                // Today styling
                if (dateStr === today) {
                    element.classList.add('today');
                }
            });
        }

        function updateSelectionSummary() {
            const dateCount = selectedDates.size;
            saveInlineBtn.disabled = dateCount === 0;
            
            if (dateCount === 0) {
                selectedDatesList.innerHTML = '<p class="text-sm text-gray-600 dark:text-gray-300">Select dates on the calendar to begin.</p>';
                return;
            }
            
            const sortedDates = Array.from(selectedDates).sort();
            const dateRanges = getDateRanges(sortedDates);
            
            selectedDatesList.innerHTML = '<div class="space-y-2">' + dateRanges.map(range => {
                if (range.start === range.end) {
                    return `<span class="inline-block bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-100 px-2 py-1 rounded text-sm mr-2">${formatDate(range.start)}</span>`;
                } else {
                    return `<span class="inline-block bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-100 px-2 py-1 rounded text-sm mr-2">${formatDate(range.start)} - ${formatDate(range.end)}</span>`;
                }
            }).join('') + '</div>';
        }

        function getDateRanges(dates) {
            if (dates.length === 0) return [];
            
            const ranges = [];
            let start = dates[0];
            let end = dates[0];
            
            for (let i = 1; i < dates.length; i++) {
                const current = new Date(dates[i]);
                const previous = new Date(dates[i - 1]);
                
                if (current.getTime() - previous.getTime() === 86400000) { // 1 day in milliseconds
                    end = dates[i];
            } else {
                    ranges.push({ start, end });
                    start = dates[i];
                    end = dates[i];
                }
            }
            
            ranges.push({ start, end });
            return ranges;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function resetSelection() {
            selectedDates.clear();
            updateSelectionSummary();
        }

        // Inline form submission
        inlineEntryForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            if (selectedDates.size === 0) {
                showToast('Please select at least one date', 'error');
                return;
            }

            const inlinePrice = parseFloat(inlinePriceInput.value);
            const inlineBooking = document.querySelector('input[name="inline-booking"]:checked').value;
            
            // Validate form data
            if (!inlinePriceInput.value || !inlinePrice || inlinePrice <= 0) {
                showToast('Please enter a valid price', 'error');
                return;
            }
            
            if (!inlineBooking) {
                showToast('Please select a booking status', 'error');
                return;
            }
            
            const entries = Array.from(selectedDates).map(date => ({
                unit_id: currentUnit,
                date: date,
                listed_price: inlinePrice,
                was_booked: inlineBooking === 'booked' ? 'Y' : 'N'
            }));
            
            try {
                // Save all entries
                for (const entry of entries) {
                    const response = await fetch('/log_entry', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(entry)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `Failed to save entry for ${entry.date} (${response.status})`);
                    }
                    
                    const result = await response.json();
                    console.log('Entry saved:', result);
                }
                
                showToast(`Successfully saved ${entries.length} price entries`, 'success');
                resetSelection();
                inlineEntryForm.reset();
                await loadExistingBookings();
                renderCalendar();

            } catch (error) {
                console.error('Error saving inline entries:', error);
                showToast(`Error: ${error.message}`, 'error');
            }
        });

        // Calendar will be initialized when a unit is selected
    });
</script>
{% endblock %}
