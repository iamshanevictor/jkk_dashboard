{% extends "base.html" %}

{% block title %}Analytics - Rentalytics{% endblock %}

{% block content %}
    <div class="mb-6">
        <h2 class="text-2xl font-semibold text-themed">Analytics & Insights</h2>
        <p class="text-themed-muted text-sm mt-1">Analyze your vacation rental pricing performance and booking insights</p>
    </div>

    <!-- Property Cards for Unit Selection -->
    <div class="mb-8">
        <h3 class="text-lg font-medium text-themed mb-4">Select Property Unit</h3>
        <div id="unitCardsContainer" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
            <!-- Unit cards will be injected here -->
        </div>
    </div>

    <!-- Analytics Content -->
    <div id="insightsContent" class="hidden">
        <!-- Summary Cards for Analytics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="stat-card p-6 rounded-lg border-l-4 border-blue-500">
                <h3 class="text-sm font-medium text-themed-muted">Average Prices</h3>
                <p class="text-sm text-themed mt-2" id="avgPrices"></p>
            </div>
            <div class="stat-card p-6 rounded-lg border-l-4 border-purple-500">
                <h3 class="text-sm font-medium text-themed-muted">Booking Rate</h3>
                <p class="text-3xl font-bold text-themed mt-2" id="bookingRate"></p>
            </div>
            <div class="stat-card p-6 rounded-lg border-l-4 border-green-500">
                <h3 class="text-sm font-medium text-themed-muted">Booking Rate by Day</h3>
                <ul id="bookingRateByDayList" class="list-disc list-inside mt-2 text-themed-muted text-sm">
                    <!-- Booking rate by day will be injected here -->
                </ul>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="content-card p-6 rounded-lg">
                <h3 class="text-lg font-semibold text-themed mb-4">Price Comparison Trend</h3>
                <div class="relative h-72">
                    <canvas id="priceComparisonChart"></canvas>
                </div>
            </div>
            <div class="content-card p-6 rounded-lg">
                <h3 class="text-lg font-semibold text-themed mb-4">Booking Rate by Day of Week</h3>
                <div class="relative h-72">
                    <canvas id="bookingRateDayChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Missed Opportunities Table -->
        <div class="content-card p-6 rounded-lg mb-8">
            <h3 class="text-lg font-semibold text-themed mb-4">Missed Opportunities</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-900">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-themed-muted uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-themed-muted uppercase tracking-wider">Unit ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-themed-muted uppercase tracking-wider">Our Price</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-themed-muted uppercase tracking-wider">Comp Avg Price</th>
                        </tr>
                    </thead>
                    <tbody id="missedOpportunitiesTableBody" class="divide-y divide-gray-700">
                        <!-- Missed opportunities will be injected here -->
                    </tbody>
                </table>
            </div>
            <p id="noMissedOpportunities" class="text-themed-muted mt-4 hidden">No missed opportunities detected for the selected period.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let priceComparisonChart, bookingRateDayChart;
        let selectedUnitId = null;
        
        // Analytics Section
        document.addEventListener('DOMContentLoaded', function() {
            const unitCardsContainer = document.getElementById('unitCardsContainer');
            const insightsContent = document.getElementById('insightsContent');
            const avgPrices = document.getElementById('avgPrices');
            const bookingRate = document.getElementById('bookingRate');
            const bookingRateByDayList = document.getElementById('bookingRateByDayList');
            const missedOpportunitiesTableBody = document.getElementById('missedOpportunitiesTableBody');
            const noMissedOpportunities = document.getElementById('noMissedOpportunities');

            // Fetch properties to populate the unit cards
            fetch('/api/properties/all')
                .then(response => response.json())
                .then(data => {
                    // Create unit cards
                    data.forEach((prop, index) => {
                        const card = document.createElement('div');
                        card.className = 'unit-card p-3 rounded-lg border-2 border-gray-700 cursor-pointer transition-all duration-200 hover:border-blue-500 min-h-20 flex flex-col justify-between relative';
                        card.innerHTML = `
                            <div>
                                <div class="text-sm font-semibold text-white">${prop.unit_id}</div>
                                <div class="text-xs text-gray-400">${prop.property_name}</div>
                            </div>
                            <div class="checkmark absolute top-2 right-2 hidden">
                                <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        `;
                        
                        card.addEventListener('click', function() {
                            // Remove active state from all cards
                            document.querySelectorAll('.unit-card').forEach(c => {
                                c.classList.remove('border-blue-500', 'bg-gray-800', 'ring-2', 'ring-blue-500');
                                c.querySelector('.checkmark').classList.add('hidden');
                            });
                            
                            // Add active state to clicked card
                            card.classList.add('border-blue-500', 'bg-gray-800', 'ring-2', 'ring-blue-500');
                            card.querySelector('.checkmark').classList.remove('hidden');
                            
                            selectedUnitId = prop.unit_id;
                            fetchInsights(prop.unit_id);
                        });
                        
                        unitCardsContainer.appendChild(card);
                        
                        // Select first property by default
                        if (index === 0) {
                            card.click();
                        }
                    });
                })
                .catch(error => console.error('Error fetching properties:', error));

            function fetchInsights(unitId) {
                let url = `/api/insights/${unitId}`;
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => Promise.reject(err));
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (Object.keys(data.insights).length === 0 || !data.insights.chart_data || data.insights.chart_data.length === 0) {
                            insightsContent.classList.add('hidden');
                            return;
                        }

                        insightsContent.classList.remove('hidden');
                        const insights = data.insights;

                        // Update Summary Cards
                        avgPrices.textContent = `₱${insights.avg_our_price} | Comp: ₱${insights.avg_comp_price}`;
                        bookingRate.textContent = `${insights.booking_rate}%`;

                        // Update Booking Rate by Day
                        bookingRateByDayList.innerHTML = '';
                        const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                        daysOfWeek.forEach(day => {
                            const rate = insights.booking_rate_by_day[day] !== undefined ? insights.booking_rate_by_day[day].toFixed(2) : '0.00';
                            const listItem = document.createElement('li');
                            listItem.textContent = `${day}: ${rate}%`;
                            bookingRateByDayList.appendChild(listItem);
                        });

                        // Update Missed Opportunities Table
                        missedOpportunitiesTableBody.innerHTML = '';
                        if (insights.missed_opportunities && insights.missed_opportunities.length > 0) {
                            noMissedOpportunities.classList.add('hidden');
                            insights.missed_opportunities.forEach(mo => {
                                const row = missedOpportunitiesTableBody.insertRow();
                                row.innerHTML = `
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-themed">${mo.date}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-themed">${mo.unit_id}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-themed">₱${mo.our_price}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-themed">₱${mo.comp_avg_price}</td>
                                `;
                            });
                        } else {
                            noMissedOpportunities.classList.remove('hidden');
                        }

                        // Update Chart.js (Price Comparison)
                        if (priceComparisonChart) {
                            priceComparisonChart.destroy();
                        }
                        const ctxPrice = document.getElementById('priceComparisonChart').getContext('2d');
                        priceComparisonChart = new Chart(ctxPrice, {
                            type: 'line',
                            data: {
                                labels: insights.chart_data.map(item => item.date),
                                datasets: [
                                    {
                                        label: 'Our Listed Price',
                                        data: insights.chart_data.map(item => item.our_price),
                                        borderColor: 'rgba(59, 130, 246, 1)',
                                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                        tension: 0.3,
                                        fill: false
                                    },
                                    {
                                        label: 'Competitor Avg Price',
                                        data: insights.chart_data.map(item => item.comp_price),
                                        borderColor: 'rgba(239, 68, 68, 1)',
                                        backgroundColor: 'rgba(239, 68, 68, 0.2)',
                                        tension: 0.3,
                                        fill: false
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });

                        // Update Chart.js (Booking Rate by Day)
                        if (bookingRateDayChart) {
                            bookingRateDayChart.destroy();
                        }
                        const ctxBooking = document.getElementById('bookingRateDayChart').getContext('2d');
                        const bookingRateDays = Object.keys(insights.booking_rate_by_day);
                        const bookingRateValues = Object.values(insights.booking_rate_by_day).map(rate => rate.toFixed(2));
                        bookingRateDayChart = new Chart(ctxBooking, {
                            type: 'bar',
                            data: {
                                labels: bookingRateDays,
                                datasets: [{
                                    label: 'Booking Rate %',
                                    data: bookingRateValues,
                                    backgroundColor: 'rgba(168, 85, 247, 0.6)',
                                    borderColor: 'rgba(168, 85, 247, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100
                                    }
                                }
                            }
                        });

                    })
                    .catch(error => {
                        console.error('Error fetching insights:', error);
                        insightsContent.classList.add('hidden');
                    });
            }
        });
    </script>
{% endblock %}
